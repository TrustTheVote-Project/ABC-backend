AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: >
  ABC back end

Parameters:
  environment:
    Type: String

# More info about Globals: https://github.com/awslabs/serverless-application-model/blob/master/docs/globals.rst
Globals:
  Function:
    Timeout: 15
    Handler: app.lambdaHandler
    Runtime: nodejs18.x
    Environment:
      Variables:
        DEPLOYMENT_ENVIRONMENT: !Sub "${environment}"
        VOTERS_TABLE_NAME: !Sub "abc_voters_${environment}"
        VOTER_SESSIONS_TABLE_NAME: !Sub "abc_voter_sessions_${environment}"
        ELECTIONS_TABLE_NAME: !Sub "abc_elections_${environment}"
        BALLOTS_TABLE_NAME: !Sub "abc_election_ballots_${environment}"
        PRECINCTS_TABLE_NAME: !Sub "abc_election_precincts_${environment}"
        FILES_TABLE_NAME: !Sub "abc_files_${environment}"
        APPLICATION_TABLE_NAME: !Sub "abc_application_${environment}"
        ELECTIONS_DOCUMENT_BUCKET: !Sub "abc-documents-${environment}"
        UPLOAD_BUCKET: !Sub "abc-uploads-${environment}"
        AUTHORIZATION_FUNCTION: !Sub "AUTHORIZATION-FUNCTION-${environment}"

  Api:
    # Allows any site to call these APIs (can restrict by replacing asterisk with site name)
    # Automatically adds AllowMethods with a list of methods for this API
    EndpointConfiguration: EDGE      
    Cors:
      AllowMethods: "'*'"
      AllowHeaders: "'Content-Type'"
      AllowOrigin: "'*'" 

Resources:
  Documents:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub "abc-documents-${environment}"
      CorsConfiguration:
        CorsRules:
        - AllowedHeaders:
          - "*"
          AllowedMethods:
          - GET
          - PUT
          - POST
          - DELETE
          - HEAD
          AllowedOrigins:
          - "*"

  DocumentBucketPolicy:
    Type: AWS::S3::BucketPolicy
    Properties:
      Bucket: !Ref Documents
      PolicyDocument:
        Id: PublicReadPolicy
        Version: 2012-10-17
        Statement:
          - Sid: PublicReadForGetBucketObjects
            Effect: Allow
            Principal: '*'
            Action: 's3:GetObject'
            Resource: !Sub arn:aws:s3:::${Documents}/*

  Uploads:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub "abc-uploads-${environment}"
      CorsConfiguration:
        CorsRules:
        - AllowedHeaders:
          - "*"
          AllowedMethods:
          - GET
          - PUT
          - POST
          - DELETE
          - HEAD
          AllowedOrigins:
          - "*"
  Elections:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub "abc_elections_${environment}"
      BillingMode: PAY_PER_REQUEST
      KeySchema:
        - AttributeName: "electionId"
          KeyType: "HASH"
      AttributeDefinitions:
        - AttributeName: "electionId"
          AttributeType: "S"
  Application:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub "abc_application_${environment}"
      BillingMode: PAY_PER_REQUEST
      KeySchema:
        - AttributeName: "applicationAttribute"
          KeyType: "HASH"
      AttributeDefinitions:
        - AttributeName: "applicationAttribute"
          AttributeType: "S"
  Files:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub "abc_files_${environment}"
      BillingMode: PAY_PER_REQUEST
      KeySchema:
        - AttributeName: "fileKey"
          KeyType: "HASH"
      AttributeDefinitions:
        - AttributeName: "fileKey"
          AttributeType: "S"

  # If we do this we may be better off using the API/lambda implementation for data population so that
  # insertion creates the necessary items in each of the lookup tables and we can keep that logic
  # in one place in the lib/Voter.js code.
  Voters:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub "abc_voters_${environment}"
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: VIDN_electionId_latMode
          AttributeType: S
        - AttributeName: SSN
          AttributeType: S
        - AttributeName: "yearOfBirth"
          AttributeType: "S"
        - AttributeName: "lastName"
          AttributeType: "S"
        - AttributeName: "ZIP5"
          AttributeType: "S"
        - AttributeName: "SSNPlus"
          AttributeType: "S"
        - AttributeName: "AddressPlus"
          AttributeType: "S"
        - AttributeName: "DLNhashTruncated_electionId_latMode"
          AttributeType: "S"
        - AttributeName: "stateIDNhashTruncated_electionId_latMode"
          AttributeType: "S"
        - AttributeName: "SSN4HashPlus_electionId_latMode"
          AttributeType: "S"

      KeySchema:
        - AttributeName: VIDN_electionId_latMode
          KeyType: HASH
      GlobalSecondaryIndexes:
        - IndexName: "lastName-ZIP5-index"
          Projection:
            ProjectionType: "ALL"
          KeySchema:
            - KeyType: "HASH"
              AttributeName: "lastName"
            - KeyType: "RANGE"
              AttributeName: "ZIP5"

        - IndexName: "SSN-index"
          Projection:
            ProjectionType: "ALL"
          KeySchema:
            - KeyType: "HASH"
              AttributeName: "SSN"
        - IndexName: "DLN-index"
          Projection:
            ProjectionType: "ALL"
          KeySchema:
            - KeyType: "HASH"
              AttributeName: "DLNhashTruncated_electionId_latMode"
            - KeyType: "RANGE"
              AttributeName: "yearOfBirth"
        - IndexName: "stateIDN-index"
          Projection:
            ProjectionType: "ALL"
          KeySchema:
            - KeyType: "HASH"
              AttributeName: "stateIDNhashTruncated_electionId_latMode"
            - KeyType: "RANGE"
              AttributeName: "yearOfBirth"
        - IndexName: "SSNPlus-index"
          Projection:
            ProjectionType: "ALL"
          KeySchema:
            - KeyType: "HASH"
              AttributeName: "SSNPlus"
        - IndexName: "SSN4HashPlus-index"
          Projection:
            ProjectionType: "ALL"
          KeySchema:
            - KeyType: "HASH"
              AttributeName: "SSN4HashPlus_electionId_latMode"
        - IndexName: "AddressPlus-index"
          Projection:
            ProjectionType: "ALL"
          KeySchema:
            - KeyType: "HASH"
              AttributeName: "AddressPlus"
      Tags:
        - Key: BillingGroup
          Value: !Sub "abc_${environment}"

  VoterSessions:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub "abc_voter_sessions_${environment}"
      BillingMode: PAY_PER_REQUEST
      KeySchema:
        - AttributeName: "VIDN_electionId_latMode"
          KeyType: "HASH"
        - AttributeName: "timestamp"
          KeyType: "RANGE"
      AttributeDefinitions:
        - AttributeName: "VIDN_electionId_latMode"
          AttributeType: "S"
        - AttributeName: "timestamp"
          AttributeType: "N"

  ElectionBallots:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub "abc_election_ballots_${environment}"
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
      - AttributeName: "electionId_ballotId"
        AttributeType: "S"
      - AttributeName: "electionId"
        AttributeType: "S"
      KeySchema:
      - AttributeName: "electionId_ballotId"
        KeyType: "HASH"
      GlobalSecondaryIndexes:
        - IndexName: "electionId-index"
          Projection:
            ProjectionType: "ALL"
          KeySchema:
            - KeyType: "HASH"
              AttributeName: "electionId"
  ElectionPrecincts:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub "abc_election_precincts_${environment}"
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
      - AttributeName: "electionId_precinctId"
        AttributeType: "S"
      - AttributeName: "electionId"
        AttributeType: "S"
      KeySchema:
      - AttributeName: "electionId_precinctId"
        KeyType: "HASH"
      GlobalSecondaryIndexes:
        - IndexName: "electionId-index"
          Projection:
            ProjectionType: "ALL"
          KeySchema:
            - KeyType: "HASH"
              AttributeName: "electionId"


  # We'll also want a table for:
  # Ballots (I think can include both PDF urls/encoded data as well as metadata)
  # Elections
  # AffidavitTemplates
  # Logs (or just Errors?)
  # VoterEvents (signed up, requested ballot, incompleted ballot, completed ballot)
  # * use VIDN as hash key, event date as sort key? possibly 2ndary index on event type?

  AbcBackendApiGateway:
    Type: AWS::Serverless::Api
    Properties:
      Name: !Sub "abc-backend__${environment}"
      StageName: !Sub "${environment}"
      # BinaryMediaTypes: 
      #   - "*~1*"
      Cors:
        AllowMethods: "'*'"
        AllowHeaders: "'*'"
        AllowOrigin: "'*'"
      GatewayResponses:
        DEFAULT_4XX:
          ResponseParameters:
            Headers:
              Access-Control-Expose-Headers: "'WWW-Authenticate'"
              Access-Control-Allow-Origin: "'*'"
        DEFAULT_5XX:
          ResponseParameters:
            Headers:
              Access-Control-Expose-Headers: "'WWW-Authenticate'"
              Access-Control-Allow-Origin: "'*'"


      # TODO: Auth stuff is TBD
      Auth:
        DefaultAuthorizer: LambdaRequestAuthorizer
        AddDefaultAuthorizerToCorsPreflight: False
        Authorizers:
          LambdaRequestAuthorizer:
            FunctionPayloadType: REQUEST
            FunctionArn: !GetAtt AuthorizationFunction.Arn
            AuthorizerPayloadFormatVersion: 2.0
            AuthorizerResultTtlInSeconds: 0
            Identity:
              Headers:
                - Authorization
              ReauthorizeEvery: 0
      # GatewayResponses:
      #   UNAUTHORIZED:
      #     StatusCode: 401
      #     ResponseTemplates:
      #       "application/json": '{"message": "provide basic auth" }'
      #       "text/html": 'Unauthorized'
      #     ResponseParameters:
      #       Headers:
      #         WWW-Authenticate: "'Basic'"

  LibLayer:
    Type: AWS::Serverless::LayerVersion
    Properties:
      LayerName: abc-backend-lambda-lib
      Description: Common code for ABC backend
      ContentUri: lib/
      CompatibleRuntimes:
        - nodejs18.x

  # TODO: Auth stuff is TBD
  # AuthFunction:
  #   Type: AWS::Serverless::Function # More info about Function Resource: https://github.com/awslabs/serverless-application-model/blob/master/versions/2016-10-31.md#awsserverlessfunction
  #   Properties:
  #     CodeUri: auth/
  #     Handler: app.handler
  #     Layers:
  #       - !Ref LibLayer

  # AdminIndexFunction:
  #   Type: AWS::Serverless::Function # More info about Function Resource: https://github.com/awslabs/serverless-application-model/blob/master/versions/2016-10-31.md#awsserverlessfunction
  #   Properties:
  #     CodeUri: admin/
  #     Handler: app.index
  #     Layers:
  #       - !Ref LibLayer
  #     Events:
  #       VotereadyApiGateway:
  #         Type: Api
  #         Properties:
  #           RestApiId: !Ref VotereadyApiGateway
  #           Path: /admin
  #           Method: GET
  #           Auth:
  #             Authorizer: LambdaBasicAuth
  #     Policies:
  #       - DynamoDBCrudPolicy:
  #           TableName: !Sub "voteready_users_${environment}"

  getElectionFunction:
    Type: AWS::Serverless::Function # More info about Function Resource: https://github.com/awslabs/serverless-application-model/blob/master/versions/2016-10-31.md#awsserverlessfunction
    Properties:
      CodeUri: endpoints/getElection/
      Layers:
        - !Ref LibLayer
      Events:
        AbcBackendApiGateway:
          Type: Api
          Properties:
            RestApiId: !Ref AbcBackendApiGateway
            Path: /getElection
            Method: ANY
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Sub "abc_elections_${environment}"
        - DynamoDBCrudPolicy:
            TableName: !Sub "abc_application_${environment}"
        - DynamoDBCrudPolicy:
            TableName: !Sub "abc_voters_${environment}"
        - S3FullAccessPolicy:
            BucketName: !Sub "abc-documents-${environment}"

  getCurrentElectionFunction:
    Type: AWS::Serverless::Function # More info about Function Resource: https://github.com/awslabs/serverless-application-model/blob/master/versions/2016-10-31.md#awsserverlessfunction
    Properties:
      CodeUri: endpoints/getCurrentElection/
      Layers:
        - !Ref LibLayer
      Events:
        AbcBackendApiGateway:
          Type: Api
          Properties:
            RestApiId: !Ref AbcBackendApiGateway
            Path: /getCurrentElection
            Method: ANY
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Sub "abc_elections_${environment}"
        - DynamoDBCrudPolicy:
            TableName: !Sub "abc_voters_${environment}"
        - DynamoDBCrudPolicy:
            TableName: !Sub "abc_application_${environment}"
        - S3FullAccessPolicy:
            BucketName: !Sub "abc-documents-${environment}"

  createElectionFunction:
    Type: AWS::Serverless::Function # More info about Function Resource: https://github.com/awslabs/serverless-application-model/blob/master/versions/2016-10-31.md#awsserverlessfunction
    Properties:
      CodeUri: endpoints/createElection/
      Layers:
        - !Ref LibLayer
      Events:
        AbcBackendApiGateway:
          Type: Api
          Properties:
            RestApiId: !Ref AbcBackendApiGateway
            Path: /createElection
            Method: ANY
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Sub "abc_elections_${environment}"

  getConfigurationsFunction:
    Type: AWS::Serverless::Function # More info about Function Resource: https://github.com/awslabs/serverless-application-model/blob/master/versions/2016-10-31.md#awsserverlessfunction
    Properties:
      CodeUri: endpoints/getConfigurations/
      Layers:
        - !Ref LibLayer
      Events:
        AbcBackendApiGateway:
          Type: Api
          Properties:
            RestApiId: !Ref AbcBackendApiGateway
            Path: /getConfigurations
            Method: GET
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Sub "abc_elections_${environment}"
        - DynamoDBCrudPolicy:
            TableName: !Sub "abc_application_${environment}"        
        - DynamoDBCrudPolicy:
            TableName: !Sub "abc_voters_${environment}"
  getElectionDefinitionFunction:
    Type: AWS::Serverless::Function # More info about Function Resource: https://github.com/awslabs/serverless-application-model/blob/master/versions/2016-10-31.md#awsserverlessfunction
    Properties:
      CodeUri: endpoints/getElectionDefinition/
      Layers:
        - !Ref LibLayer
      Events:
        AbcBackendApiGateway:
          Type: Api
          Properties:
            RestApiId: !Ref AbcBackendApiGateway
            Path: /getElectionDefinition
            Method: GET
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Sub "abc_elections_${environment}"
        - DynamoDBCrudPolicy:
            TableName: !Sub "abc_application_${environment}"
        - DynamoDBCrudPolicy:
            TableName: !Sub "abc_files_${environment}"
        - S3CrudPolicy:
            BucketName: !Sub "abc-uploads-${environment}"
        - S3CrudPolicy:
            BucketName: !Sub "abc-documents-${environment}"
  
  getElectionDefinitionStatusFunction:
    Type: AWS::Serverless::Function # More info about Function Resource: https://github.com/awslabs/serverless-application-model/blob/master/versions/2016-10-31.md#awsserverlessfunction
    Properties:
      CodeUri: endpoints/getElectionDefinitionStatus/
      Layers:
        - !Ref LibLayer
      Events:
        AbcBackendApiGateway:
          Type: Api
          Properties:
            RestApiId: !Ref AbcBackendApiGateway
            Path: /getElectionDefinitionStatus
            Method: POST
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Sub "abc_elections_${environment}"
        - DynamoDBCrudPolicy:
            TableName: !Sub "abc_files_${environment}"
  getAffidavitTemplateFunction:
    Type: AWS::Serverless::Function # More info about Function Resource: https://github.com/awslabs/serverless-application-model/blob/master/versions/2016-10-31.md#awsserverlessfunction
    Properties:
      CodeUri: endpoints/getAffidavitTemplate/
      Layers:
        - !Ref LibLayer
      Events:
        AbcBackendApiGateway:
          Type: Api
          Properties:
            RestApiId: !Ref AbcBackendApiGateway
            Path: /getAffidavitTemplate
            Method: GET
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Sub "abc_elections_${environment}"
        - DynamoDBCrudPolicy:
            TableName: !Sub "abc_application_${environment}"
        - DynamoDBCrudPolicy:
            TableName: !Sub "abc_voters_${environment}"
        - S3FullAccessPolicy:
            BucketName: !Sub "abc-documents-${environment}"

  # getTestPrintPageFunction:
  #   Type: AWS::Serverless::Function # More info about Function Resource: https://github.com/awslabs/serverless-application-model/blob/master/versions/2016-10-31.md#awsserverlessfunction
  #   Properties:
  #     CodeUri: endpoints/getTestPrintPage/
  #     Layers:
  #       - !Ref LibLayer
  #     Events:
  #       AbcBackendApiGateway:
  #         Type: Api
  #         Properties:
  #           RestApiId: !Ref AbcBackendApiGateway
  #           Path: /getTestPrintPage
  #           Method: GET
  #     Policies:
  #       - DynamoDBCrudPolicy:
  #           TableName: !Sub "abc_elections_${environment}"
  #       - DynamoDBCrudPolicy:
  #           TableName: !Sub "abc_application_${environment}"
  #       - DynamoDBCrudPolicy:
  #           TableName: !Sub "abc_voters_${environment}"
  #       - S3FullAccessPolicy:
  #           BucketName: !Sub "abc-documents-${environment}"

  getBlankBallotFunction:
    Type: AWS::Serverless::Function # More info about Function Resource: https://github.com/awslabs/serverless-application-model/blob/master/versions/2016-10-31.md#awsserverlessfunction
    Properties:
      CodeUri: endpoints/getBlankBallot/
      Layers:
        - !Ref LibLayer
      Events:
        AbcBackendApiGateway:
          Type: Api
          Properties:
            RestApiId: !Ref AbcBackendApiGateway
            Path: /getBlankBallot
            Method: POST
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Sub "abc_elections_${environment}"
        - DynamoDBCrudPolicy:
            TableName: !Sub "abc_application_${environment}"
        - DynamoDBCrudPolicy:
            TableName: !Sub "abc_voters_${environment}"
        - S3FullAccessPolicy:
            BucketName: !Sub "abc-documents-${environment}"

  getBallotDefinitionFunction:
    Type: AWS::Serverless::Function # More info about Function Resource: https://github.com/awslabs/serverless-application-model/blob/master/versions/2016-10-31.md#awsserverlessfunction
    Properties:
      CodeUri: endpoints/getBallotDefinition/
      Layers:
        - !Ref LibLayer
      Events:
        AbcBackendApiGateway:
          Type: Api
          Properties:
            RestApiId: !Ref AbcBackendApiGateway
            Path: /getBallotDefinition
            Method: POST
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Sub "abc_elections_${environment}"
        - DynamoDBCrudPolicy:
            TableName: !Sub "abc_application_${environment}"
        - DynamoDBCrudPolicy:
            TableName: !Sub "abc_voters_${environment}"

  lookupVoterByIDnumberFunction:
    Type: AWS::Serverless::Function # More info about Function Resource: https://github.com/awslabs/serverless-application-model/blob/master/versions/2016-10-31.md#awsserverlessfunction
    Properties:
      CodeUri: endpoints/lookupVoterByIDnumber/
      Layers:
        - !Ref LibLayer
      Events:
        AbcBackendApiGateway:
          Type: Api
          Properties:
            RestApiId: !Ref AbcBackendApiGateway
            Path: /lookupVoterByIDnumber
            Method: POST
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Sub "abc_elections_${environment}"
        - DynamoDBCrudPolicy:
            TableName: !Sub "abc_application_${environment}"
        - DynamoDBCrudPolicy:
            TableName: !Sub "abc_voters_${environment}"

  lookupVoterBySSN4Function:
    Type: AWS::Serverless::Function # More info about Function Resource: https://github.com/awslabs/serverless-application-model/blob/master/versions/2016-10-31.md#awsserverlessfunction
    Properties:
      CodeUri: endpoints/lookupVoterBySSN4/
      Layers:
        - !Ref LibLayer
      Events:
        AbcBackendApiGateway:
          Type: Api
          Properties:
            RestApiId: !Ref AbcBackendApiGateway
            Path: /lookupVoterBySSN4
            Method: POST
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Sub "abc_elections_${environment}"
        - DynamoDBCrudPolicy:
            TableName: !Sub "abc_application_${environment}"
        - DynamoDBCrudPolicy:
            TableName: !Sub "abc_voters_${environment}"

  lookupVoterByAddressFunction:
    Type: AWS::Serverless::Function # More info about Function Resource: https://github.com/awslabs/serverless-application-model/blob/master/versions/2016-10-31.md#awsserverlessfunction
    Properties:
      CodeUri: endpoints/lookupVoterByAddress/
      Layers:
        - !Ref LibLayer
      Events:
        AbcBackendApiGateway:
          Type: Api
          Properties:
            RestApiId: !Ref AbcBackendApiGateway
            Path: /lookupVoterByAddress
            Method: POST
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Sub "abc_elections_${environment}"
        - DynamoDBCrudPolicy:
            TableName: !Sub "abc_application_${environment}"
        - DynamoDBCrudPolicy:
            TableName: !Sub "abc_voters_${environment}"

  lookupVoterEmailFunction:
    Type: AWS::Serverless::Function # More info about Function Resource: https://github.com/awslabs/serverless-application-model/blob/master/versions/2016-10-31.md#awsserverlessfunction
    Properties:
      CodeUri: endpoints/lookupVoterEmail/
      Layers:
        - !Ref LibLayer
      Events:
        AbcBackendApiGateway:
          Type: Api
          Properties:
            RestApiId: !Ref AbcBackendApiGateway
            Path: /lookupVoterEmail
            Method: POST
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Sub "abc_elections_${environment}"
        - DynamoDBCrudPolicy:
            TableName: !Sub "abc_application_${environment}"
        - DynamoDBCrudPolicy:
            TableName: !Sub "abc_voters_${environment}"

  postBeginFunction:
    Type: AWS::Serverless::Function # More info about Function Resource: https://github.com/awslabs/serverless-application-model/blob/master/versions/2016-10-31.md#awsserverlessfunction
    Properties:
      CodeUri: endpoints/postBegin/
      Layers:
        - !Ref LibLayer
      Events:
        AbcBackendApiGateway:
          Type: Api
          Properties:
            RestApiId: !Ref AbcBackendApiGateway
            Path: /postBegin
            Method: POST
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Sub "abc_elections_${environment}"
        - DynamoDBCrudPolicy:
            TableName: !Sub "abc_application_${environment}"
        - DynamoDBCrudPolicy:
            TableName: !Sub "abc_voters_${environment}"
        - DynamoDBCrudPolicy:
            TableName: !Sub "abc_voter_sessions_${environment}"

  postCompleteFunction:
    Type: AWS::Serverless::Function # More info about Function Resource: https://github.com/awslabs/serverless-application-model/blob/master/versions/2016-10-31.md#awsserverlessfunction
    Properties:
      CodeUri: endpoints/postComplete/
      Layers:
        - !Ref LibLayer
      Events:
        AbcBackendApiGateway:
          Type: Api
          Properties:
            RestApiId: !Ref AbcBackendApiGateway
            Path: /postComplete
            Method: POST
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Sub "abc_elections_${environment}"
        - DynamoDBCrudPolicy:
            TableName: !Sub "abc_application_${environment}"
        - DynamoDBCrudPolicy:
            TableName: !Sub "abc_voters_${environment}"
        - DynamoDBCrudPolicy:
            TableName: !Sub "abc_voter_sessions_${environment}"

  postIncompleteFunction:
    Type: AWS::Serverless::Function # More info about Function Resource: https://github.com/awslabs/serverless-application-model/blob/master/versions/2016-10-31.md#awsserverlessfunction
    Properties:
      CodeUri: endpoints/postIncomplete/
      Layers:
        - !Ref LibLayer
      Events:
        AbcBackendApiGateway:
          Type: Api
          Properties:
            RestApiId: !Ref AbcBackendApiGateway
            Path: /postIncomplete
            Method: POST
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Sub "abc_elections_${environment}"
        - DynamoDBCrudPolicy:
            TableName: !Sub "abc_application_${environment}"
        - DynamoDBCrudPolicy:
            TableName: !Sub "abc_voters_${environment}"
        - DynamoDBCrudPolicy:
            TableName: !Sub "abc_voter_sessions_${environment}"


  setElectionAttributesFunction:
    Type: AWS::Serverless::Function # More info about Function Resource: https://github.com/awslabs/serverless-application-model/blob/master/versions/2016-10-31.md#awsserverlessfunction
    Properties:
      CodeUri: endpoints/setElectionAttributes/
      Layers:
        - !Ref LibLayer
      Events:
        AbcBackendApiGateway:
          Type: Api
          Properties:
            RestApiId: !Ref AbcBackendApiGateway
            Path: /setElectionAttributes
            Method: POST
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Sub "abc_elections_${environment}"
        - DynamoDBCrudPolicy:
            TableName: !Sub "abc_application_${environment}"
        - DynamoDBCrudPolicy:
            TableName: !Sub "abc_voters_${environment}"

  openElectionLookupFunction:
    Type: AWS::Serverless::Function # More info about Function Resource: https://github.com/awslabs/serverless-application-model/blob/master/versions/2016-10-31.md#awsserverlessfunction
    Properties:
      CodeUri: endpoints/openElectionLookup/
      Layers:
        - !Ref LibLayer
      Events:
        AbcBackendApiGateway:
          Type: Api
          Properties:
            RestApiId: !Ref AbcBackendApiGateway
            Path: /openElectionLookup
            Method: POST
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Sub "abc_elections_${environment}"
        - DynamoDBCrudPolicy:
            TableName: !Sub "abc_application_${environment}"
        - DynamoDBCrudPolicy:
            TableName: !Sub "abc_voters_${environment}"

  openElectionFunction:
    Type: AWS::Serverless::Function # More info about Function Resource: https://github.com/awslabs/serverless-application-model/blob/master/versions/2016-10-31.md#awsserverlessfunction
    Properties:
      CodeUri: endpoints/openElection/
      Layers:
        - !Ref LibLayer
      Events:
        AbcBackendApiGateway:
          Type: Api
          Properties:
            RestApiId: !Ref AbcBackendApiGateway
            Path: /openElection
            Method: POST
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Sub "abc_elections_${environment}"
        - DynamoDBCrudPolicy:
            TableName: !Sub "abc_application_${environment}"
        - DynamoDBCrudPolicy:
            TableName: !Sub "abc_voters_${environment}"
  openElectionTestFunction:
    Type: AWS::Serverless::Function # More info about Function Resource: https://github.com/awslabs/serverless-application-model/blob/master/versions/2016-10-31.md#awsserverlessfunction
    Properties:
      CodeUri: endpoints/openElectionTest/
      Layers:
        - !Ref LibLayer
      Events:
        AbcBackendApiGateway:
          Type: Api
          Properties:
            RestApiId: !Ref AbcBackendApiGateway
            Path: /openElectionTest
            Method: POST
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Sub "abc_elections_${environment}"
        - DynamoDBCrudPolicy:
            TableName: !Sub "abc_application_${environment}"
        - DynamoDBCrudPolicy:
            TableName: !Sub "abc_voters_${environment}"
  closeElectionFunction:
    Type: AWS::Serverless::Function # More info about Function Resource: https://github.com/awslabs/serverless-application-model/blob/master/versions/2016-10-31.md#awsserverlessfunction
    Properties:
      CodeUri: endpoints/closeElection/
      Layers:
        - !Ref LibLayer
      Events:
        AbcBackendApiGateway:
          Type: Api
          Properties:
            RestApiId: !Ref AbcBackendApiGateway
            Path: /closeElection
            Method: POST
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Sub "abc_elections_${environment}"
        - DynamoDBCrudPolicy:
            TableName: !Sub "abc_application_${environment}"
        - DynamoDBCrudPolicy:
            TableName: !Sub "abc_voters_${environment}"
  closeElectionTestFunction:
    Type: AWS::Serverless::Function # More info about Function Resource: https://github.com/awslabs/serverless-application-model/blob/master/versions/2016-10-31.md#awsserverlessfunction
    Properties:
      CodeUri: endpoints/closeElectionTest/
      Layers:
        - !Ref LibLayer
      Events:
        AbcBackendApiGateway:
          Type: Api
          Properties:
            RestApiId: !Ref AbcBackendApiGateway
            Path: /closeElectionTest
            Method: POST
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Sub "abc_elections_${environment}"
        - DynamoDBCrudPolicy:
            TableName: !Sub "abc_application_${environment}"
        - DynamoDBCrudPolicy:
            TableName: !Sub "abc_voters_${environment}"

  setElectionTestCompleteFunction:
    Type: AWS::Serverless::Function # More info about Function Resource: https://github.com/awslabs/serverless-application-model/blob/master/versions/2016-10-31.md#awsserverlessfunction
    Properties:
      CodeUri: endpoints/setElectionTestComplete/
      Layers:
        - !Ref LibLayer
      Events:
        AbcBackendApiGateway:
          Type: Api
          Properties:
            RestApiId: !Ref AbcBackendApiGateway
            Path: /setElectionTestComplete
            Method: POST
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Sub "abc_elections_${environment}"
        - DynamoDBCrudPolicy:
            TableName: !Sub "abc_application_${environment}"
        - DynamoDBCrudPolicy:
            TableName: !Sub "abc_voters_${environment}"



  setCurrentElectionFunction:
    Type: AWS::Serverless::Function # More info about Function Resource: https://github.com/awslabs/serverless-application-model/blob/master/versions/2016-10-31.md#awsserverlessfunction
    Properties:
      CodeUri: endpoints/setCurrentElection/
      Layers:
        - !Ref LibLayer
      Events:
        AbcBackendApiGateway:
          Type: Api
          Properties:
            RestApiId: !Ref AbcBackendApiGateway
            Path: /setCurrentElection
            Method: POST
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Sub "abc_application_${environment}"
        - DynamoDBCrudPolicy:
            TableName: !Sub "abc_elections_${environment}"
  setElectionConfigurationsFunction:
    Type: AWS::Serverless::Function # More info about Function Resource: https://github.com/awslabs/serverless-application-model/blob/master/versions/2016-10-31.md#awsserverlessfunction
    Properties:
      CodeUri: endpoints/setElectionConfigurations/
      Layers:
        - !Ref LibLayer
      Events:
        AbcBackendApiGateway:
          Type: Api
          Properties:
            RestApiId: !Ref AbcBackendApiGateway
            Path: /setElectionConfigurations
            Method: POST
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Sub "abc_elections_${environment}"
        - DynamoDBCrudPolicy:
            TableName: !Sub "abc_application_${environment}"

  getFileUploadStatusFunction:
    Type: AWS::Serverless::Function # More info about Function Resource: https://github.com/awslabs/serverless-application-model/blob/master/versions/2016-10-31.md#awsserverlessfunction
    Properties:
        CodeUri: endpoints/getFileUploadStatus/
        Layers:
          - !Ref LibLayer
        Events:
          AbcBackendApiGateway:
            Type: Api
            Properties:
              RestApiId: !Ref AbcBackendApiGateway
              Path: /getFileUploadStatus
              Method: POST
        Policies:
          - DynamoDBCrudPolicy:
              TableName: !Sub "abc_application_${environment}"
          - DynamoDBCrudPolicy:
              TableName: !Sub "abc_files_${environment}"

  setElectionDefinitionFunction:
    Type: AWS::Serverless::Function # More info about Function Resource: https://github.com/awslabs/serverless-application-model/blob/master/versions/2016-10-31.md#awsserverlessfunction
    Properties:
      CodeUri: endpoints/setElectionDefinition/
      Layers:
        - !Ref LibLayer
      Events:
        AbcBackendApiGateway:
          Type: Api
          Properties:
            RestApiId: !Ref AbcBackendApiGateway
            Path: /setElectionDefinition
            Method: POST
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Sub "abc_elections_${environment}"
        - DynamoDBCrudPolicy:
            TableName: !Sub "abc_application_${environment}"
        - DynamoDBCrudPolicy:
            TableName: !Sub "abc_files_${environment}"
        - DynamoDBCrudPolicy:
            TableName: !Sub "abc_election_ballots_${environment}"
        - DynamoDBCrudPolicy:
            TableName: !Sub "abc_election_precincts_${environment}"
        - S3CrudPolicy:
            BucketName: !Sub "abc-uploads-${environment}"
        - S3CrudPolicy:
            BucketName: !Sub "abc-documents-${environment}"
  setElectionVotersFunction:
    Type: AWS::Serverless::Function # More info about Function Resource: https://github.com/awslabs/serverless-application-model/blob/master/versions/2016-10-31.md#awsserverlessfunction
    Properties:
      CodeUri: endpoints/setElectionVoters/
      Layers:
        - !Ref LibLayer
      Events:
        AbcBackendApiGateway:
          Type: Api
          Properties:
            RestApiId: !Ref AbcBackendApiGateway
            Path: /setElectionVoters
            Method: POST
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Sub "abc_voters_${environment}"
        - DynamoDBCrudPolicy:
            TableName: !Sub "abc_elections_${environment}"
        - DynamoDBCrudPolicy:
            TableName: !Sub "abc_files_${environment}"
        - DynamoDBCrudPolicy:
            TableName: !Sub "abc_application_${environment}"
        - DynamoDBCrudPolicy:
            TableName: !Sub "abc_election_ballots_${environment}"
        - DynamoDBCrudPolicy:
            TableName: !Sub "abc_election_precincts_${environment}"
        - S3CrudPolicy:
            BucketName: !Sub "abc-uploads-${environment}"
        - S3CrudPolicy:
            BucketName: !Sub "abc-documents-${environment}"

  setElectionTestVotersFunction:
    Type: AWS::Serverless::Function # More info about Function Resource: https://github.com/awslabs/serverless-application-model/blob/master/versions/2016-10-31.md#awsserverlessfunction
    Properties:
      CodeUri: endpoints/setElectionTestVoters/
      Layers:
        - !Ref LibLayer
      Events:
        AbcBackendApiGateway:
          Type: Api
          Properties:
            RestApiId: !Ref AbcBackendApiGateway
            Path: /setElectionTestVoters
            Method: POST
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Sub "abc_voters_${environment}"
        - DynamoDBCrudPolicy:
            TableName: !Sub "abc_elections_${environment}"
        - DynamoDBCrudPolicy:
            TableName: !Sub "abc_files_${environment}"
        - DynamoDBCrudPolicy:
            TableName: !Sub "abc_application_${environment}"
        - DynamoDBCrudPolicy:
            TableName: !Sub "abc_election_ballots_${environment}"
        - DynamoDBCrudPolicy:
            TableName: !Sub "abc_election_precincts_${environment}"
        - S3CrudPolicy:
            BucketName: !Sub "abc-uploads-${environment}"
        - S3CrudPolicy:
            BucketName: !Sub "abc-documents-${environment}"

  setAffidavitTemplateFunction:
    Type: AWS::Serverless::Function # More info about Function Resource: https://github.com/awslabs/serverless-application-model/blob/master/versions/2016-10-31.md#awsserverlessfunction
    Properties:
      CodeUri: endpoints/setAffidavitTemplate/
      Layers:
        - !Ref LibLayer
      Events:
        AbcBackendApiGateway:
          Type: Api
          Properties:
            RestApiId: !Ref AbcBackendApiGateway
            Path: /setAffidavitTemplate
            Method: POST
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Sub "abc_elections_${environment}"
        - DynamoDBCrudPolicy:
            TableName: !Sub "abc_application_${environment}"

  # setBallotDefinitionsFunction:
  #   Type: AWS::Serverless::Function # More info about Function Resource: https://github.com/awslabs/serverless-application-model/blob/master/versions/2016-10-31.md#awsserverlessfunction
  #   Properties:
  #     CodeUri: endpoints/setBallotDefinitions/
  #     Layers:
  #       - !Ref LibLayer
  #     Events:
  #       AbcBackendApiGateway:
  #         Type: Api
  #         Properties:
  #           RestApiId: !Ref AbcBackendApiGateway
  #           Path: /setBallotDefinitions
  #           Method: POST
  #     Policies:
  #       - DynamoDBCrudPolicy:
  #           TableName: !Sub "abc_elections_${environment}"
  #       - DynamoDBCrudPolicy:
  #           TableName: !Sub "abc_application_${environment}"

  setElectionBallotsFunction:
    Type: AWS::Serverless::Function # More info about Function Resource: https://github.com/awslabs/serverless-application-model/blob/master/versions/2016-10-31.md#awsserverlessfunction
    Properties:
      CodeUri: endpoints/setElectionBallots/
      Layers:
        - !Ref LibLayer
      Events:
        AbcBackendApiGateway:
          Type: Api
          Properties:
            RestApiId: !Ref AbcBackendApiGateway
            Path: /setElectionBallots
            Method: POST
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Sub "abc_elections_${environment}"
        - DynamoDBCrudPolicy:
            TableName: !Sub "abc_application_${environment}"
        - DynamoDBCrudPolicy:
            TableName: !Sub "abc_election_ballots_${environment}"
        - DynamoDBCrudPolicy:
            TableName: !Sub "abc_election_precincts_${environment}"
        - DynamoDBCrudPolicy:
            TableName: !Sub "abc_files_${environment}"
        - S3CrudPolicy:
            BucketName: !Sub "abc-uploads-${environment}"
        - S3CrudPolicy:
            BucketName: !Sub "abc-documents-${environment}"


  provisionUploadFunction:
    Type: AWS::Serverless::Function # More info about Function Resource: https://github.com/awslabs/serverless-application-model/blob/master/versions/2016-10-31.md#awsserverlessfunction
    Properties:
      CodeUri: endpoints/provisionUpload/
      Layers:
        - !Ref LibLayer
      Events:
        AbcBackendApiGateway:
          Type: Api
          Properties:
            RestApiId: !Ref AbcBackendApiGateway
            Path: /provisionUpload
            Method: ANY
      Policies:
        - S3CrudPolicy:
            BucketName: !Sub "abc-uploads-${environment}"
        - DynamoDBCrudPolicy:
            TableName: !Sub "abc_application_${environment}"
        - DynamoDBCrudPolicy:
            TableName: !Sub "abc_files_${environment}"
  
  # This should be depricated in favor of processProvisionedUpload
  unzipProvisionedUploadFunction:
    Type: AWS::Serverless::Function # More info about Function Resource: https://github.com/awslabs/serverless-application-model/blob/master/versions/2016-10-31.md#awsserverlessfunction
    Properties:
      CodeUri: endpoints/processProvisionedUpload/
      Layers:
        - !Ref LibLayer
      Events:
        AbcBackendApiGateway:
          Type: Api
          Properties:
            RestApiId: !Ref AbcBackendApiGateway
            Path: /unzipProvisionedUpload
            Method: ANY
      Policies:
        - S3CrudPolicy:
            BucketName: !Sub "abc-uploads-${environment}"
        - DynamoDBCrudPolicy:
            TableName: !Sub "abc_application_${environment}"
        - DynamoDBCrudPolicy:
            TableName: !Sub "abc_files_${environment}"

  processProvisionedUploadFunction:
    Type: AWS::Serverless::Function # More info about Function Resource: https://github.com/awslabs/serverless-application-model/blob/master/versions/2016-10-31.md#awsserverlessfunction
    Properties:
      CodeUri: endpoints/processProvisionedUpload/
      Layers:
        - !Ref LibLayer
      Events:
        AbcBackendApiGateway:
          Type: Api
          Properties:
            RestApiId: !Ref AbcBackendApiGateway
            Path: /processProvisionedUpload
            Method: ANY
      Policies:
        - S3CrudPolicy:
            BucketName: !Sub "abc-uploads-${environment}"
        - DynamoDBCrudPolicy:
            TableName: !Sub "abc_application_${environment}"
        - DynamoDBCrudPolicy:
            TableName: !Sub "abc_files_${environment}"

  loginFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: endpoints/admin/login/
      Layers:
        - !Ref LibLayer
      Timeout: 300
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Sub "abc_application_${environment}"
      Events:
        AbcBackendApiGateway:
          Type: Api
          Properties:
            RestApiId: !Ref AbcBackendApiGateway
            Path: /admin/login
            Method: ANY
  
  logoutFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: endpoints/admin/logout/
      Layers:
        - !Ref LibLayer
      Timeout: 300
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Sub "abc_application_${environment}"
      Events:
        AbcBackendApiGateway:
          Type: Api
          Properties:
            RestApiId: !Ref AbcBackendApiGateway
            Path: /admin/logout
            Method: ANY

  selfFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: endpoints/admin/self/
      Layers:
        - !Ref LibLayer
      Timeout: 300
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Sub "abc_application_${environment}"
      Events:
        AbcBackendApiGateway:
          Type: Api
          Properties:
            RestApiId: !Ref AbcBackendApiGateway
            Path: /admin/self
            Method: ANY
            

  ProcessUpload:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: workers/processProvisionedUpload/
      Layers:
        - !Ref LibLayer
      Timeout: 300
      Policies:
        - S3CrudPolicy:
            BucketName: !Sub "abc-uploads-${environment}"
        - DynamoDBCrudPolicy:
            TableName: !Sub "abc_application_${environment}"
      Events:
        ZipUploadedEvent:
          Type: S3
          Properties:
            Bucket: !Ref Uploads
            Events: s3:ObjectCreated:*
  
  


  unknownEndpointFunction:
    Type: AWS::Serverless::Function # More info about Function Resource: https://github.com/awslabs/serverless-application-model/blob/master/versions/2016-10-31.md#awsserverlessfunction
    Properties:
      CodeUri: endpoints/unknownEndpoint/
      Layers:
        - !Ref LibLayer
      Events:
        AbcBackendApiGateway:
          Type: Api
          Properties:
            RestApiId: !Ref AbcBackendApiGateway
            Path: /{proxy+} # Any path not defined elsewhere
            Method: Any
            Auth:
              Authorizer: null
            

  AuthorizationFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: authorization/
      Layers:
        - !Ref LibLayer
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Sub "abc_application_${environment}"

Outputs:
  # GatewayDomain:
  #   # ID.execute-api-.us-east-1amazonaws.com/STAGE
  #   # STAGE === environment
  #   Description: Domain ID for API Gateway
  #   value: !GetAtt AbcBackendApiGateway.RootResourceId

  lookupVoterByIDnumberFunction:
    Description: "Get voter by unique voterIdNumber attribute"
    Value: !GetAtt lookupVoterByIDnumberFunction.Arn

  AuthorizationFunction:
    Description: Authorization Function for ABC API
    Value: !GetAtt AuthorizationFunction.Arn
    Export:
      Name: !Sub "AUTHORIZATION-FUNCTION-${environment}"

  ProdDataEndpoint:
    Description: "API Prod stage endpoint"
    Value: !Sub "https://${AbcBackendApiGateway}.execute-api.${AWS::Region}.amazonaws.com/${environment}/"
